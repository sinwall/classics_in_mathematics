<html>
<head>
<meta charset="utf-8">
<script>
MathJax = {
    tex: {
        inlineMath: [['$', '$']],
        macros: {
            ol: ["\\overline{#1}", 1],
            // wideparen: ["\\overparen{#1}", 1]
        }
    },
    // fonts: ["STIX"],
    svg: {
        fontCache: "global"
    }
};
</script>
<script id="MathJax-script" async src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-chtml.js"></script>
<!-- <script src="https://unpkg.com/mathlive"></script> -->
<script type="importmap">
{
    "imports": {
        "three": "./module-three/src/Three.js",
        "three/addons/": "./module-three/examples/jsm/"
    }
}
</script>
<style>
.boxed {
    /* border: solid; */
    box-shadow: 0 0 0 2px #000 inset;
}
.row {
    position: relative;
}
.col {
    position: relative;
    float:left;
}
.text-col-body{
    height:80%;
    overflow-y: scroll;
}
.text-col-foot{
    height:15%;
    overflow-y: scroll;
}
.unselectable {
    -webkit-touch-callout: none;
    -webkit-user-select: none;
    -khtml-user-select: none;
    -moz-user-select: none;
    -ms-user-select: none;
    user-select: none;
}
.multilayer {
    position: relative;
}
.language-layer {
    position: absolute;
}
.text-dialect {
    color: red;
}
</style>
</head>

<body>

 <div id="page-title" class="row boxed" style="width: 1200px; text-align: center; font-size: 20pt">
Mathematica Classica per Linguas Figurasque
    <div id="nav-wrapper">
    <button id="button-fig-prev">◁</button>
    <select name="fig" id="select-fig"></select>
    <button id="button-fig-next">▷</button>
    </div>
 </div>

 <div id="page-content" class="row boxed" style="width: 1200px; height:800px;">
  <div id="page-content-col1" class="col boxed" style="width:32%; height:100%;">
    <div id="page-content-col1-title" class="row boxed">
    Column 1
    <select id="select-lang1"></select>
    </div>
    <div id="page-content-col1-body" class="row boxed text-col-body" style="white-space:break-spaces; ">
    Content 1
    </div>
    <div id="page-content-col1-foot" class="row text-col-foot boxed" style="white-space:break-spaces;"></div>
  </div>
  <div id="page-content-col2" class="col boxed" style="width:32%; height:100%;">
    <div id="page-content-col2-title" class="row boxed">
    Column 2
    <select id="select-lang2"></select>
    </div>
    <div id="page-content-col2-body" class="row boxed text-col-body" style="white-space:break-spaces;">
    Content 2
    </div>
    <div id="page-content-col2-foot" class="row text-col-foot boxed" style="white-space:break-spaces;"></div>
  </div>
  <div id="page-content-col3" class="col boxed" style="height:100%;">
    <div id="page-content-col3-title" class="row boxed">
    Column 3
    </div>
    <div id="svg-wrapper" class="row boxed" style="position: relative; width: 400px; height: 400px;">
    </div>
    <div class="boxed">
    Select construction step
     <button id="button-back">◁</button>
     <select name="step" id="select-step">
     </select>
     <button id="button-forward">▷</button>
     <input id="check-original" type="checkbox">original</input>
    </div>
  </div>
 </div>

</body>

</html>
<script type="module">
// import {readFileSync} from 'fs'

function renderMath() {
    MathJax.typeset();
    // MathLive.renderMathInDocument(
    //     {
    //         TeX: {
    //             delimiters: {
    //                 inline: [['$', '$']]
    //             }
    //         },
    //         macros: {
    //             ol: '\\overline{#1}'
    //         }
    //     }
    // );
}
async function loadRawTextJson(sourcePath) {
    let result;
    await new Promise(function (resolve, reject) {
        let xhr = new XMLHttpRequest();
        xhr.open("GET", sourcePath)
        xhr.onload = function () {
            if ((xhr.status >= 200) && (xhr.status < 400)) {
                result = JSON.parse(xhr.responseText);
            }
            else {
                ;
                // reject();
            }
            resolve();
        }
        xhr.send();
    })
    return result;
}

function loadSectionAndDo(sectionName, callback) {
    let promises = []
    for (let lang of metaData.languages) {
        promises.push(
            new Promise(function (resolve, reject) {
                let xhr = new XMLHttpRequest();
                xhr.open('GET', `/text/on-spirals/${sectionName}/${lang}`);
                xhr.onload = function () {
                    if ((xhr.status >= 200) & (xhr.status < 400)) {
                        let texts = [];
                        let footnotes = [];
                        let responseJSON = JSON.parse(xhr.responseText);
                        let node = document.createElement('div');
                        node.innerHTML = responseJSON.text;
                        node.querySelectorAll('p')
                            .forEach(function (pElt) {texts.push(pElt.innerHTML);});
                        node.innerHTML = responseJSON.footnote;
                        node.querySelectorAll('p')
                            .forEach(function (pElt) {footnotes.push(pElt.innerHTML);});
                        node.remove();
                        resolve({texts, footnotes});
                    } else {
                        reject();
                    }
                };
                xhr.send();
            })
        );
    }
    Promise.all(promises)
        .then(
            function (resolved) {
                let texts = {};
                let footnotes = {};
                for (let i=0; i<metaData.languages.length; i++) {
                    texts[metaData.languages[i]] = resolved[i].texts;
                    footnotes[metaData.languages[i]] = resolved[i].footnotes;
                }
                callback(texts, footnotes);
            }
        );

}

function arrangeMultilayerSize(textColumn) {
    let outers = textColumn.querySelectorAll('.multilayer')
    for (let outer of outers) {
        for (let inner of outer.querySelectorAll('.language-layer')) {
            if (Number(outer.style.height.replace('px','')) < inner.offsetHeight) {
                outer.style.height = `${inner.offsetHeight}px`;
            }
        }
    }
}

function insertTextToElement(textColumn, section) {
    for (let i=textColumn.childNodes.length; i>0; i--) {
        textColumn.childNodes[0].remove();
    }
    let languages = metaData.languages;
    let numParagraph = section.ELH.length;
    for (let i=0; i<numParagraph; i++) {
        let outer = document.createElement('div');
        outer.classList.add('multilayer', 'boxed');
        textColumn.appendChild(outer);
        // outer.style = 'position: relative;';
        for (let j=0; j<languages.length; j++) {
            let inner = document.createElement('div');
            inner.classList.add(languages[j], 'language-layer');
            // inner.style = 'position: absolute;';
            inner.innerHTML = section[languages[j]][i];
            outer.appendChild(inner);
            // if (Number(outer.style.height.replace('px','')) < inner.offsetHeight) {
            //     outer.style.height = `${inner.offsetHeight}px`;
            // }
        }
    }
    renderMath();
    arrangeMultilayerSize(textColumn);
}

function insertFootnoteToElement(footColumn, section) {
    for (let i=footColumn.childNodes.length; i>0; i--) {
        footColumn.childNodes[0].remove();
    }
    let outer = document.createElement('div');
    outer.classList.add('multilayer', 'boxed');
    footColumn.append(outer);
    let languages = metaData.languages;
    for (let j=0; j<languages.length; j++) {
        let inner = document.createElement('div');
        inner.classList.add(languages[j], 'language-layer');
        section[languages[j]].forEach(function(s) {inner.innerHTML += `<div>${s}</div>`;});
        outer.appendChild(inner);
    }
    renderMath();
}

function refactorIds(htmlString, suffix) {
    htmlString = htmlString.replaceAll(
        /id="footnote(ptr)?-[A-Z]{3}-\d/g, 
        function (match) {return `${match}(${suffix})`;}
    )
    htmlString = htmlString.replaceAll(
        /href="#footnote(ptr)?-[A-Z]{3}-\d/g, 
        function (match) {return `${match}(${suffix})`;}
    )
    return htmlString
}

async function setSection(index) {
    document.getElementById("select-fig-"+index).selected = true;
    geometer.clear();
    await Promise.all([
        geometer.loadSource(
            sourceList[index],
            function () {
                let selectStep = document.getElementById("select-step");
                for (let i=selectStep.childNodes.length; i>0; i--) {
                    selectStep.childNodes[0].remove();
                }
                for (let i=geometer.stepMin; i<=geometer.stepMax; i++) {
                    let option = document.createElement("option");
                    option.value = i;
                    option.textContent = i;
                    option.setAttribute("id", "select-step-"+i);
                    document.getElementById("select-step").appendChild(option);
                    if (i==geometer.stepMin) {option.selected = true;}
                };
                if (document.getElementById("check-original").checked) {
                    geometer.toggleOriginal()
                }
            }
        ),
        loadSectionAndDo(
            metaData.sections[index],
            function (texts, footnotes) {
                for (let j=1; j<=2; j++) {
                    let textsIdModified = {};
                    let footnotesIdModified = {};
                    for (let lang of metaData.languages) {
                        textsIdModified[lang] = texts[lang].map(
                            function (s) {return refactorIds(s, j);}
                        );
                        footnotesIdModified[lang] = footnotes[lang].map(
                            function (s) {return refactorIds(s, j);}
                        );
                    }
                    insertTextToElement(
                        document.getElementById(`page-content-col${j}-body`),
                        textsIdModified
                    );
                    insertFootnoteToElement(
                        document.getElementById(`page-content-col${j}-foot`),
                        footnotesIdModified
                    );
                    document.getElementById("select-lang"+j).onchange();
                }
            }
        )
    ]);
}

import {Geometer} from "/static/geometer.js"

let metaData;
await new Promise(function(resolve, reject) {
    let xhr = new XMLHttpRequest();
    xhr.open('GET', '/metadata/on-spirals');
    xhr.onload = function () {
        metaData = JSON.parse(xhr.responseText);
        resolve();
    };
    xhr.send();
});

let sourceList = [
    "/static/on_spirals/Intro",
    "/static/on_spirals/prop01",
    "/static/on_spirals/prop02",
    "/static/on_spirals/prop03",
    "/static/on_spirals/prop04",
    "/static/on_spirals/prop05",
    "/static/on_spirals/prop06",
    "/static/on_spirals/prop07",
    "/static/on_spirals/prop08",
    "/static/on_spirals/prop09",
    "/static/on_spirals/prop10",
    "/static/on_spirals/prop11",
];
let langList = metaData.languages;
let langDetailList = metaData.languagesDetail;

let geometer = new Geometer(document.getElementById("svg-wrapper"))
geometer.domElement.classList.add("boxed")

// proposition navigation
document.getElementById("button-fig-prev").onclick = async function () {
    let i = +document.getElementById("select-fig").value;
    if (i <= 0) { return; }
    setSection(i-1);
};
document.getElementById("button-fig-next").onclick = async function () {
    let i = +document.getElementById("select-fig").value;
    if (i >= sourceList.length-1) { return; }
    setSection(i+1);
};
document.getElementById("select-fig").onchange = async function () {
    let i = +document.getElementById("select-fig").value;
    setSection(i);
}
for (let i=0; i<sourceList.length; i++) {
    let option = document.createElement("option");
    option.value = i;
    option.textContent = sourceList[i];
    option.setAttribute("id", "select-fig-"+i);
    document.getElementById("select-fig").appendChild(option);
}
for (let j=1; j<=2; j++) {
    let selectProp = document.getElementById('select-fig');
    let selectLang = document.getElementById("select-lang"+j);
    for (let i=0; i<langList.length; i++) {
        let option = document.createElement("option");
        option.value = i;
        option.textContent = langDetailList[i];
        option.setAttribute("id", "select-lang" + j +"-"+i);
        selectLang.appendChild(option);
    }
    selectLang.onchange = function () {
        let i = selectLang.value;
        document.getElementById(`page-content-col${j}`)
            .querySelectorAll('.language-layer')
            .forEach(el => {el.style.opacity = 0; el.style.zIndex = -1; el.classList.add('unselectable');});
        document.getElementById(`page-content-col${j}`)
            .querySelectorAll(`.${langList[i]}`)
            .forEach(el => {el.style.opacity = 1; el.style.zIndex = 1; el.classList.remove('unselectable')});
        // if (langList[i] == "KOM") {
        //     renderMath();
        // }
    }
    document.getElementById(`page-content-col${j}-body`).onscroll = function () {
        for (let el of document.body.querySelectorAll('.text-col-body')) {
            el.scrollTop = this.scrollTop;
        }
    }
}


// diagram navigation
document.getElementById("button-back").onclick = function () {
    geometer.stepBack();
    document.getElementById("select-step-"+geometer.step).selected = true;
};
document.getElementById("button-forward").onclick = function () {
    geometer.stepForward();
    document.getElementById("select-step-"+geometer.step).selected = true;
};
document.getElementById("select-step").onchange = function () {
    for (let i=geometer.step; i<this.value; i++) {
        geometer.stepForward();
    }
    for (let i=geometer.step; i>this.value; i--) {
        geometer.stepBack();
    }
}
document.getElementById("check-original").onchange = function () {
    geometer.toggleOriginal();
    document.getElementById("button-back").disabled = !document.getElementById("button-back").disabled;
    document.getElementById("button-forward").disabled = !document.getElementById("button-forward").disabled;
    document.getElementById("select-step").disabled = !document.getElementById("select-step").disabled;
};


let idxInit = sourceList.length-1
idxInit=0;
document.getElementById("select-lang2-1").selected = true;
setSection(idxInit);

</script>